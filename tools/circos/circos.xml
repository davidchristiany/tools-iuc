<?xml version="1.0"?>
<tool id="circgraph" name="Circos" version="@WRAPPER_VERSION@">
    <description>builds plots from standard bioinformatics datatypes.</description>
    <macros>
        <import>macros.xml</import>
        <import>macros_conffiles.xml</import>
        <import>macros_tests.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>circos --version</version_command>
    <command detect_errors="exit_code"><![CDATA[
set -ex;
## Directory structure
mkdir -p circos/conf/ circos/data/ &&

#if $reference_genome.ref.ref_source == 'history':
    ln -s '$reference_genome.ref.genome_fasta' genomeref.fa &&
#end if

#if $reference_genome.ref.ref_source == 'lengths':
    python '$__tool_directory__/genome-lengths-to-karyotype.py'
        ${reference_genome.ref.input_lengths}
        > circos/conf/karyotype.txt &&
#else if $reference_genome.ref.ref_source == 'karyotype':
    cp $reference_genome.ref.input_karyotype circos/conf/karyotype.txt &&
#else:
    ## Process the karyotype.txt file
    python '$__tool_directory__/fasta-to-karyotype.py'

    #if str($reference_genome.ref.ref_source) == 'cached':
        '${reference_genome.ref.fasta_indexes.fields.path}'
    #else if str($reference_genome.ref.ref_source) == 'history':
        genomeref.fa
    #end if
    > circos/conf/karyotype.txt &&
#end if

touch circos/conf/karyotype-colors.conf &&
#if $reference_genome.bands:
    #if $reference_genome.convert_bands:
        python '$__tool_directory__/process-cytogenetic-bands.py'
            '${reference_genome.bands}'
            >> circos/conf/karyotype.txt
            2> circos/conf/karyotype-colors.conf &&
    #else
        cat '${reference_genome.bands}'
            >> circos/conf/karyotype.txt &&
    #end if
#end if

#if $plot_options.colour_profile:
    #if str($plot_options.colour_profile) == 'cg':
        cat '$__tool_directory__/colours/cg.conf' >> circos/conf/karyotype-colors.conf &&
    #end if
#end if

mv '$circos_conf' circos/conf/circos.conf &&
mv '$ticks_conf' circos/conf/ticks.conf &&
mv '$ideogram_conf' circos/conf/ideogram.conf &&
mv '$data_conf'  circos/conf/data.conf &&
mv '$highlight_conf'  circos/conf/highlight.conf &&
mv '$links_conf'  circos/conf/links.conf &&
mv '$test_case_conf' circos/conf/galaxy_test_case.xml &&

## Highlights
#for $hi, $data in enumerate($sec_highlight.data):
cp '${data.data_source}' circos/data/highlight-${hi}.txt &&
#end for

## 2D Data Plots
#for $hi, $data in enumerate($sec_tdd.data):
    cp '${data.plot_format.data_source}' circos/data/data-${hi}.txt &&
#end for

## Link Tracks
#for $hi, $data in enumerate($sec_links.data):
    cp '${data.data_source}' circos/data/links-${hi}.txt &&
#end for

#if $outputs.tar == "yes"
    tar cvfz circos.tar.gz circos
#else
    echo ''
#end if

#if $outputs.svg == "yes" or $outputs.png == "yes":
    && circos -conf circos/conf/circos.conf -noparanoid
#end if
    ]]></command>
    <configfiles>
        <expand macro="configfile_circos_conf" />
        <expand macro="configfile_ticks_conf" />
        <expand macro="configfile_ideogram_conf" />
        <expand macro="configfile_data_conf" />
        <expand macro="configfile_links_conf" />
        <expand macro="configfile_highlight_conf" />
        <expand macro="test_case" />
    </configfiles>
    <inputs>
        <section name="reference_genome" title="Reference Genome and Cytogenetic Bands" expanded="true">
            <conditional name="ref">
                <param name="ref_source" type="select" label="Reference Genome">
                    <option value="history" selected="True">From History</option>
                    <option value="cached">Locally Cached</option>
                    <option value="karyotype">Karyotype</option>
                    <option value="lengths">Lengths File</option>
                </param>
                <when value="cached">
                    <param name="fasta_indexes" type="select" label="Source FASTA Sequence">
                        <options from_data_table="all_fasta"/>
                    </param>
                </when>
                <when value="history">
                    <param name="genome_fasta" type="data" format="fasta" label="Source FASTA Sequence"/>
                </when>
                <when value="karyotype">
                    <param name="input_karyotype" type="data" format="tabular,txt" label="Karyotype Configuration"/>
                </when>
                <when value="lengths">
                    <param name="input_lengths" type="data" format="tabular" label="Sequence Lengths" help="This needs to be a 2+ column tabular, e.g. from 'Compute sequence lengths', the first column should be chromosome and second should be length."/>
                </when>
            </conditional>
            <param name="limit_chromosomes" type="text" optional="true" label="Limit/Filter Chromosomes" help="Syntax is: 'hs1;hs2;hs3' (-hs1 syntax is not currently supported.) You can additionally select a subset of a chromosome with the syntax: 'hs1:1-1000;hs2:3000-9000'">
                <sanitizer>
                    <valid initial="string.letters,string.digits">
                        <add value=","/>
                        <add value="_"/>
                        <add value="."/>
                        <add value=":"/>
                        <add value=";"/>
                        <add value="-"/>
                    </valid>
                </sanitizer>
            </param>
            <param name="chromosomes_reverse" type="text" optional="true" label="Reverse these Chromosomes" help="Important: If you set this, you will need to set the limit_chromosomes option as well. Syntax is: hs1,hs2">
                <sanitizer>
                    <valid initial="string.letters,string.digits">
                        <add value=","/>
                        <add value="_"/>
                        <add value="."/>
                        <add value=":"/>
                        <add value=";"/>
                        <add value="-"/>
                    </valid>
                </sanitizer>
            </param>
            <param name="bands" type="data" format="tabular" optional="true" label="Cytogenetic Bands"
                help="If defined, will display cytogenetic bands as part of the karyotype configuration. This field accepts any tabular format file. If you provide a BED file you should enable automatic conversion below. Otherwise disable conversion below and it is expected that your file have 7 columns: 'band', chromosome ID (should match fasta), band ID, band ID (again), start, end, color (gneg, gpos, or r,g,b triple). E.g. a complete row would look like: 'band chr1 p32.2 p32.2 56100000 59000000 gneg25'"/>
            <param name="convert_bands" type="boolean" truevalue="yes" falsevalue="no" label="Convert bands from BED format to circos karyotype band format" checked="true"
                help="Automatically reformat BED file into the appropriate columns. This should be a BED 6+ file, BED 9+ if you want the colours from the BED file automatically used. Otherwise everything will appear grey."/>
        </section>
        <section name="outputs" title="Outputs" expanded="true">
            <param name="png" type="boolean" truevalue="yes" falsevalue="no" label="Output PNG" checked="true"/>
            <param name="svg" type="boolean" truevalue="yes" falsevalue="no" label="Output SVG" checked="false"/>
            <param name="tar" type="boolean" truevalue="yes" falsevalue="no" label="Output Configuration Archive" checked="false"/>
        </section>
        <section name="plot_options" title="Plot Options" expanded="true">
            <conditional name="background">
                <param name="background_select" type="select" label="Plot Format">
                    <option value="transparent">Transparent</option>
                    <option value="color" selected="true">Color</option>
                </param>
                <when value="transparent" />
                <when value="color">
                    <expand macro="circos_color" label="Background Color" name="background_color" value="#ffffff"/>
                </when>
            </conditional>
            <param name="radius" type="integer" label="Image Radius" value="1500" min="500" max="5000" help="Plot radius. Final plot dimensions will be 2*r by 2*r"/>
            <param name="colour_profile" type="select" label="Load additional colour profiles" optional="true">
                <option value="cg">Complete Genomics</option>
            </param>
        </section>

        <section name="ideogram" title="Ideogram Configuration (Genome/Chromosomes)">
            <param name="units" type="select" label="Chromosome units" help="Setting this to MB allows usage of numbers like 5u to represent 5MB, rather than having to specify 5000000 or 5e6">
                <option value="bases">Bases</option>
                <option value="kb">Kilobases</option>
                <option value="mb" selected="true">Megabases</option>
                <option value="gb">Gigabases</option>
            </param>

            <param name="spacing" type="float" value="0.005" label="Spacing Between Ideograms"/>
            <param name="radius" type="float" value="0.90" label="Radius"/>
            <param name="thickness" type="float" value="10" label="Thickness"/>

            <section name="ideogram_labels" title="Labels">
                <param name="show_label" type="boolean" truevalue="yes" falsevalue="no" label="Show Label" checked="true"/>
                <param type="float" value="0.075" label="Radius" name="radius_offset"/>
                <param type="integer" value="24" label="Label Font Size" name="size"/>
                <!--<param type="float" value="10" label="Thickness" name="thickness"/>-->
                <param name="parallel" type="boolean" label="Parallel" truevalue="yes" falsevalue="no" checked="true"
                    help="When set to yes/true, labels will be perpendicular to the tangent of the circle at the location of the label. Otherwise, they will be parallel with the tangent of the circle"/>
            </section>

            <section name="bands" title="Cytogenic Bands">
                <param name="show_bands" type="boolean" truevalue="yes" falsevalue="no" label="Show Bands" checked="true"/>
                <param name="fill_bands" type="boolean" truevalue="yes" falsevalue="no" label="Fill Bands" checked="true"/>
                <param name="band_transparency" type="integer" label="Fill Bands" value="0" min="0" max="5" help="0 is solid, 1 is the least transparent, and 5 is the most transparent"/>

                <param type="integer" value="2" label="Band Stroke Thickness" name="band_stroke_thickness"/>
                <expand macro="circos_color" label="Band Stroke Color" name="band_stroke_color" value="#000000"/>
            </section>
        </section>

        <section name="ticks" title="Ticks">
            <param name="show_ticks" type="boolean" truevalue="yes" falsevalue="no" label="Show Ticks"/>
            <param name="radius"  type="float" value="1.0" label="Radius"/>

            <repeat name="tick_group" title="Tick Group">
                <param name="spacing" type="text" value="5000" label="Tick Spacing" help="Number of bases (number + u syntax works)"/>
                <param name="size" type="float" value="10" label="Tick Size"/>
                <expand macro="circos_color"/>
                <conditional name="ticks">
                    <param name="show_tick_labels" type="boolean" truevalue="yes" falsevalue="no" label="Show Tick Labels"/>
                    <when value="yes">
                        <param name="label_size" type="float" value="20" label="Label Size"/>
                        <param name="label_offset"  type="float" value="10" label="Label Offset"/>
                        <param name="format" type="select" label="Label Format">
                            <option value="%d" selected="True">Integer</option>
                            <option value="%f">Float</option>
                            <option value="%.1f">Float (one decimal)</option>
                            <option value="%.2f">Float (two decimals)</option>
                            <sanitizer>
                                <valid>
                                    <add value="%" />
                                </valid>
                            </sanitizer>
                        </param>
                        <param name="format_ext" type="boolean" truevalue="yes" falsevalue="no" checked="true" label="Show unit in tick labels" help="If your chromosome units is set to kilobases and you have enabled this option and enabled tick labels, they will include the size value, e.g. '500 kb' "/>
                    </when>
                    <when value="no">
                    </when>
                </conditional>
            </repeat>

        </section>

        <section name="sec_highlight" title="Highlights">
            <repeat name="data" title="Highlight">
                <param name="r1" type="float" value="0.89" label="Outside Radius"/>
                <param name="r0" type="float" value="0.8" label="Inside Radius"/>
                <param name="data_source" type="data" format="tabular,bed" label="Highlight Data Source"/>
                <expand macro="circos_color_alpha" label="Fill Color" name="fill_color" value="#000000"/>
                <expand macro="rules" />
            </repeat>
        </section>

        <section name="sec_tdd" title="2D Data">
            <repeat name="data" title="2D Data Plot">
                <!-- Positioning -->
                <param name="r1" type="float" value="0.89" label="Outside Radius"/>
                <param name="r0" type="float" value="0.8" label="Inside Radius"/>
                <param name="orientation" type="boolean" label="Orient Inwards" truevalue="in" falsevalue="out"
                    help="When yes/true, the plot will face inwards. I.e. lowest values will be to the outside"/>
                <expand macro="minmax" />

                <conditional name="plot_format">
                    <param name="plot_format_select" type="select" label="Plot Format">
                        <option value="histogram" selected="True">Histogram</option>
                        <option value="histogram-stacked">Stacked Histogram</option>
                        <option value="heatmap">Heatmap</option>
                        <option value="line">Line</option>
                        <option value="scatter">Scatter</option>
                        <option value="tile">Tiles</option>
                        <option value="text">Text Labels</option>
                    </param>
                    <when value="histogram">
                        <param name="data_source" type="data" format="tabular" label="Histogram Data Source" help="Columns must be (chrom, start, end, score)"/>
                        <section name="format_specific" title="Plot Format Specific Options">
                            <expand macro="circos_color_alpha" label="Fill Color" name="fill_color" default="#ffdcfc"/>
                            <expand macro="stroke_opts"/>

                            <param name="fill_under" type="boolean" label="Fill underneath the histogram" truevalue="yes" falsevalue="no" checked="true" />
                            <param name="extend_bins" type="boolean" label="Join non-abutting Bins" truevalue="yes" falsevalue="no"
                                help="Join histogram bins that do not touch (abut)" />
                        </section>
                    </when>
                    <when value="histogram-stacked">
                        <param name="data_source" type="data" format="tabular" label="Histogram Data Source" help="Columns must be (chrom, start, end, score)"/>
                        <section name="format_specific" title="Plot Format Specific Options">
                            <expand macro="brewer_scale" label="Fill Color" name="fill_color"/>
                            <expand macro="stroke_opts"/>

                            <param name="fill_under" type="boolean" label="Fill underneath the histogram" truevalue="yes" falsevalue="no" checked="true" />
                            <param name="extend_bins" type="boolean" label="Join non-abutting Bins" truevalue="yes" falsevalue="no"
                                help="Join histogram bins that do not touch (abut)" />

                        </section>
                    </when>
                    <when value="heatmap">
                        <param name="data_source" type="data" format="tabular" label="Heatmap Data Source"/>
                        <section name="format_specific" title="Plot Format Specific Options">
                            <expand macro="brewer_scale" label="Fill Color" name="fill_color"/>
                            <param name="scale_log_base" type="float" value="1.0" label="Scale Log Base"
                                help="If scale_log_base&lt;1, the dynamic range of color mapping of small values will be increased. If scale_log_base&gt;1, then dynamic range of large values will be increased."/>
                        </section>
                    </when>
                    <when value="line">
                        <param name="data_source" type="data" format="tabular" label="Line Data Source"/>
                        <section name="format_specific" title="Plot Format Specific Options">
                            <expand macro="stroke_opts"/>
                        </section>
                    </when>
                    <when value="scatter">
                        <param name="data_source" type="data" format="tabular" label="Scatter Plot Data Source"/>
                        <section name="format_specific" title="Plot Format Specific Options">
                        <!-- glyph, glyph_size, min, max -->
                            <param name="glyph" type="select" label="Glyph">
                                <option value="circle">Circle</option>
                                <option value="triangle">Triangle</option>
                                <option value="rectangle">Rectangle</option>
                            </param>
                            <param name="glyph_size" type="integer" value="8" label="Glyph Size"/>
                            <param name="data_min" type="float" value="0.0" label="Data Minimum" help="Minimum value of the range of the plot axis, data outside this range are clipped." />
                            <param name="data_max" type="float" value="1.0" label="Data Maximum" help="Maximum value of the range of the plot axis, data outside this range are clipped." />
                            <expand macro="circos_color_alpha" name="fill_color" value="#555555" label="Color" />
                            <expand macro="stroke_opts"/>
                        </section>
                    </when>
                    <when value="tile">
                        <param name="data_source" type="data" format="tabular" label="Tile Data Source"
                            help="If your tile source features have scores in them, they will be used in colouration"/>
                        <section name="format_specific" title="Plot Format Specific Options">
                            <expand macro="circos_color_alpha" name="fill_color" label="Fill Color"/>

                            <expand macro="stroke_opts"/>
                            <param name="layers" type="integer" value="15" label="Layers"/>
                            <param name="thickness" type="float" value="15" label="Thickness" help="In pixels"/>
                            <param name="padding" type="float" value="8" label="Padding" help="In pixels"/>
                            <param name="margin" type="float" value="0.002" label="Margin" help="In chromosome units. This is essentially distance added to the gene, before laying it out. Increasing it will prevent genes from packing as well."/>

                            <conditional name="overflow">
                                <param name="overflow_behavior" type="select" label="Overflow Behavior">
                                    <option value="hide">Hide: overflow tiles are not drawn</option>
                                    <option value="grow">Grow: new layers are added as required</option>
                                    <option value="collapse">Collapse: overflow tiles are drawn on the first layer</option>
                                </param>
                                <when value="hide">
                                </when>
                                <when value="grow">
                                    <expand macro="circos_color" name="layer_overflow_color" label="Layer Overflow Color"/>
                                </when>
                                <when value="collapse">
                                    <expand macro="circos_color" name="layer_overflow_color"  label="Layer Overflow Color"/>
                                </when>
                            </conditional>
                        </section>
                    </when>
                    <when value="text">
                        <param name="data_source" type="data" format="tabular" label="Text Data Source"/>
                    </when>
                </conditional>

                <expand macro="rules" />
                <expand macro="axes" />
                <expand macro="backgrounds" />
            </repeat>
        </section>
        <section name="sec_links" title="Link Tracks">
            <repeat name="data" title="Link Data">
                <!-- Positioning -->
                <param name="radius" type="float" value="0.8" label="Inside Radius"
                    help="This is the radial position of the termination of the link; for relative values, if radius smaller than 1 then it is defined in terms of the inner ideogram radius, otherwise it is defined in terms of the outer ideogram radius" />
                <param name="data_source" type="data" format="txt" label="Link Data Source" help="Select file with link data. Format: chr1 start1 end1 chr2 start2 end2" />
                <conditional name="linktype">
                    <param name="ribbon" type="select" label="Link Type" help="">
                        <option value="no" selected="true">basic</option>
                        <option value="yes">ribbon</option>
                    </param>
                    <when value="yes">
                        <param name="twist" type="select" label="Twist Ribbon">
                            <option value="" selected="true">auto</option>
                            <option value="twist=yes">always</option>
                            <option value="flat=yes">never</option>
                        </param>
                    </when>
                    <when value="no"/>
                </conditional>
                <expand macro="circos_color_alpha" name="color" value="#000000" label="Link Color"/>
                <param name="thickness" type="float" value="15" label="Thickness" help="In pixels"/>
                <param name="bezier_radius" type="float" value="0.1" min="0" max="1" label="Bezier Radius"
                    help="The radial position of the third control point (in addition to the two positions defined by the link coordinates) used to draw the Bezier curve; if this parameter is 0 then straight lines will be used"/>

                <section name="advanced" title="Advanced Settings">
                    <param name="zdepth" type="float" value="" optional="true" label="Z-depth"
                        help="Optional. Datasets with a higher z-depth value are drawn on top of data sets with a lower value. Only useful if plotting multiple link tracks"/>
                    <param name="crest" type="float" value="0.5" min="0" max="1" label="Crest"
                        help="Two additional Bezier control points can be set by using the crest parameter. When defined, points p3 and p4 are added. These points lie at the same angular position as the start and end link termini and have the radial position. In the crest=0 extreme, p3 and p4 are at the same position as p0,p1. In this case, crest has no effect. When crest=1, p3,p4 are at the radial position of p2, the control point set by bezier_radius"/>
                    <param name="bezier_radius_purity" type="float" value="0.75" min="0" max="1" label="Bezier Radius Purity"
                        help="The bezier_radius_purity adjusts the position of p2 for each link. The p2 control point will move along the line formed by the original p2 location and the intersection of p0-p1 and the bisecting radius. When purity = 1, p2' = p2. When purity = 0, p2' = midpoint(p0,p1)"/>
                    <conditional name="perturbation">
                        <param name="perturb" type="select" label="Perturb links?"
                            help="A set of parameters can be used to randomly adjust bezier_radius, bezier_radius_purity, and crest parameters to give the links a more disorganized, organic feel. By perturbing each link you can also show additional texture in the data among links which would have ordinarily overlapped. Each parameter's perturbation amount is defined as a pair of values - pmin,pmax. These are the minimum and maximum multipliers by which the value can be perturbed">
                            <option value="no" selected="true">no</option>
                            <option value="yes">yes</option>
                        </param>
                        <when value="yes">
                            <param name="perturb_crest_min" type="float" value="0.5" label="Crest min"
                                help="For example setting (min,max) = (0.5,1.2) will cause parameter to be randomly scaled between 50-120%"/>
                            <param name="perturb_crest_max" type="float" value="1.5" label="Crest max"
                                help="For example setting (min,max) = (0.5,1.2) will cause parameter to be randomly scaled between 50-120%"/>
                            <param name="perturb_bezier_radius_min" type="float" value="0.5" label="Bezier Radius min"
                                help="For example setting (min,max) = (0.5,1.2) will cause parameter to be randomly scaled between 50-120%"/>
                            <param name="perturb_bezier_radius_max" type="float" value="1.5" label="Bezier Radius max"
                                help="For example setting (min,max) = (0.5,1.2) will cause parameter to be randomly scaled between 50-120%"/>
                            <param name="perturb_bezier_radius_purity_min" type="float" value="0.5" label="Bezier Radius Purity min"
                                help="For example setting (min,max) = (0.5,1.2) will cause parameter to be randomly scaled between 50-120%"/>
                            <param name="perturb_bezier_radius_purity_max" type="float" value="1.5" label="Bezier Radius Purity max"
                                help="For example setting (min,max) = (0.5,1.2) will cause parameter to be randomly scaled between 50-120%"/>
                        </when>
                        <when value="no"/>
                    </conditional>
                </section>
                <expand macro="linkrules"/>
            </repeat>
        </section>
    </inputs>
    <outputs>
        <data name="output_png" format="png" from_work_dir="circos.png" label="Circos Plot (png)">
            <filter>outputs['png']</filter>
        </data>
        <data name="output_svg" format="svg" from_work_dir="circos.svg" label="Circos Plot (svg)">
            <filter>outputs['svg']</filter>
        </data>
        <data name="output_tar" format="tar.gz" from_work_dir="circos.tar.gz" label="Circos Conf Files">
            <filter>outputs['tar']</filter>
        </data>
    </outputs>
    <expand macro="test_cases" />
    <help><![CDATA[
Circos
======

Circos is a software package for visualizing data and information. It visualizes data in a circular layout — this makes Circos ideal for exploring relationships between objects or positions. There are other reasons why a circular layout is advantageous, not the least being the fact that it is attractive.

Circos is ideal for creating publication-quality infographics and illustrations with a high data-to-ink ratio, richly layered data and pleasant symmetries. You have fine control each element in the figure to tailor its focus points and detail to your audience.

.. image:: $PATH_TO_IMAGES/circos-sample-panel.png
   :alt: several example circos plots

For more information see the Circos documentation_.

.. _documentation: http://circos.ca/documentation/


    ]]></help>
    <expand macro="citations" />
</tool>
